Kucheka = angular.module('Kucheka', ['ngResource', 'rails'])
filepicker.setKey('AffEtHmTETGO3pTJxeyo7z')

Kucheka.controller "KuchekaCtrl", ["$scope", "$http", "$resource", "$routeParams", "$location", ($scope, $http, $resource, $routeParams, $location) ->

  User = $resource("/api/users/:id",
    id: "@id"
  ,
    index:
      method: 'GET'
      isArray:true
  )
  users = User.index(
    a:5
  , ->
    $scope.users = users
  )

  $scope.isActive = (route) ->
    route is $location.path()
  ]

Kucheka.controller "KuchekaUserCtrl", ["$scope", "$http", "$resource", "$routeParams", "$location", ($scope, $http, $resource, $routeParams, $location) ->
  $scope.slug = $routeParams.slug

  User = $resource("/api/users/:id",
    id: "@id"
  ,
    update:
      method: 'PUT'
    index:
      method: 'GET'
      isArray:true
  )

  user = User.get(
    id: 7
    slug: $scope.slug
  , ->
    $scope.user = user
  )
  ]

Kucheka.factory "User", ["railsResourceFactory", (railsResourceFactory) ->
  railsResourceFactory
    url: "/api/users"
    name: "user"
]

Kucheka.controller "KuchekaProfileCtrl", ["$scope", "$http", "$resource", "$routeParams", "$location", "User", ($scope, $http, $resource, $routeParams, $location, User) ->
    $scope.slug = $routeParams.slug
    $scope.saveForm = ->
      window.u = $scope.user
      $scope.user.update()

    User.get(id: current_user.id).then (result) ->
      $scope.user = result

    $scope.pickFile = =>
        filepicker.pick
            mimetypes: ["image/*", "text/plain"]
            services: ["COMPUTER", "FACEBOOK", "GMAIL"]
        , ((FPFile) ->
            $scope.user.cover_image_url = FPFile.url
            $scope.$apply()

        ), (FPError) ->
            alert "error"
            console.log FPError.toString()
  ]

Kucheka.config ["$locationProvider", "$routeProvider", ($locationProvider, $routeProvider) ->
    $locationProvider.html5Mode(true)
    $routeProvider.when("/",
        templateUrl: "<%= asset_path 'angular/partials/home.tpl.html' %>"
        controller: "KuchekaCtrl"
    ).when("/about",
        templateUrl: "<%= asset_path 'angular/partials/about.tpl.html' %>"
    ).when("/profile",
        templateUrl: "<%= asset_path 'angular/partials/edit_profile.tpl.html' %>"
        controller: "KuchekaProfileCtrl"
    ).when("/:slug",
        templateUrl: "<%= asset_path 'angular/partials/profile.tpl.html' %>"
        controller: "KuchekaUserCtrl"
    ).otherwise redirectTo: "/"
  ]
