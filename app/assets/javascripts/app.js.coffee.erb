ComedyBase = angular.module('ComedyBase', ['ngResource', 'rails', 'ui', 'ui.bootstrap'])

filepicker.setKey('AffEtHmTETGO3pTJxeyo7z')

ComedyBase.factory "User", ["railsResourceFactory", (railsResourceFactory) ->
    railsResourceFactory
        url: "/api/users"
        name: "user"
]
ComedyBase.factory "Venue", ["railsResourceFactory", (railsResourceFactory) ->
    railsResourceFactory
        url: "/api/venues"
        name: "venue"
]

ComedyBase.factory "Event", ["railsResourceFactory", (railsResourceFactory) ->
  railsResourceFactory
    url: "/api/events"
    name: "event"
]

ComedyBase.factory "Place", ["railsResourceFactory", (railsResourceFactory) ->
  railsResourceFactory
    url: "/api/places"
    name: "place"
]

ComedyBase.factory "debounce", ($timeout, $q) ->
  (func, wait, immediate) ->
    timeout = undefined
    deferred = $q.defer()
    ->
      context = this
      args = arguments_
      later = ->
        timeout = null
        unless immediate
          deferred.resolve func.apply(context, args)
          deferred = $q.defer()

      callNow = immediate and not timeout
      $timeout.cancel timeout  if timeout
      timeout = $timeout(later, wait)
      if callNow
        deferred.resolve func.apply(context, args)
        deferred = $q.defer()
      deferred.promise


ComedyBase.controller "VenuesCtrl", ["$scope", "$http", "Venue", "$routeParams", "$location", "debounce", ($scope, $http, Venue, $routeParams, $location, debounce) ->

    $scope.debouncedSearch = -> debounce($scope.search, 3000, false)

    $scope.search = ->
      venues = Venue.query(query:$scope.query).then( (venues) ->
        $scope.venues = venues
      )

    $scope.isActive = (route) ->
        route is $location.path()
    ]

ComedyBase.controller "EventsCtrl", ["$scope", "$http", "Event", "$routeParams", "$location", "debounce", ($scope, $http, Event, $routeParams, $location, debounce) ->

    $scope.debouncedSearch = -> debounce($scope.search, 3000, false)

    $scope.search = ->
      venues = Event.query(query:$scope.query).then( (events) ->
        $scope.events = events
      )

    $scope.isActive = (route) ->
      route is $location.path()
    ]


ComedyBase.controller "ComedyBaseCtrl", ["$scope", "$http", "$resource", "$routeParams", "$location", ($scope, $http, $resource, $routeParams, $location) ->

  $scope.$route = $route

  users = User.query().then( (users) ->
    $scope.users = users
  )

  $scope.isActive = (route) ->
    route is $location.path()
  ]

ComedyBase.controller "ComedyBaseUserCtrl", ["$scope", "$http", "User", "$routeParams", "$location", ($scope, $http, User, $routeParams, $location) ->
  $scope.slug = $routeParams.slug
  User.get(id: $scope.slug).then( (user) ->
    $scope.user = user
    window.u = user
  )
  ]

   
ComedyBase.controller "ComedyBaseProfileCtrl", ["$scope", "$http", "User", "$routeParams", "$location", ($scope, $http, User, $routeParams, $location) ->
    $scope.slug = $routeParams.slug

    $scope.setCurrentEvent = (event) ->
        $scope.current_event = event
    $scope.updateEvent = ->
        delete $scope.current_event
    $scope.removeCurrentEvnet = ->
        delete $scope.current_event
    $scope.saveForm = ->
        $scope.user.update()
    User.get(id: current_user.id).then (result) ->
      $scope.user = result
    $scope.pickFile = =>
        filepicker.pick
            mimetypes: ["image/*", "text/plain"]
            services: ["COMPUTER", "FACEBOOK", "GMAIL"]
        , ((FPFile) =>
            $scope.user.cover_image_url = FPFile.url
            $scope.user.coverImageUrl = FPFile.url
            #window.u = $scope.user
            $scope.$apply()

        ), (FPError) ->
            alert "error"
            console.log FPError.toString()
  ]

  ComedyBase.controller "ComedyBaseProfileEventsCtrl", ["$scope", "$http", "User", "Place", "$routeParams", "$location", ($scope, $http, User, Place, $routeParams, $location) ->
    $scope.slug = $routeParams.slug
    $scope.val =  default_city.id
    $scope.set_val = (val) ->
      $("#event_venue").select2("destroy")
      $("#event_venue").removeClass("select2-offscreen")
      #$("#s2id_event_venue").replaceWith("")
      $scope.val = val
      $scope.$apply()
      select_object("#event_venue", "Choose venue", "/api/venues", $scope.set_val, {place_id: val})
    $scope.set_venue = (venue) ->
      $scope.venue = venue


    select_object("#event_city", default_city.display_name, '/api/places', $scope.set_val)
    select_object("#event_venue", "Choose venue", "/api/venues", $scope.set_venue, {place_id: $scope.val})
    select_object("#event_event", "Choose venue", "/api/venues", $scope.set_venue, {place_id: $scope.val})



  ]
    #****************************************
#* Router
#****************************************

ComedyBase.config ["$locationProvider", "$routeProvider", ($locationProvider, $routeProvider) ->
    $locationProvider.html5Mode(true)
    $routeProvider.when("/",
        templateUrl: "<%= asset_path 'angular/partials/home.tpl.html' %>"
        controller: "ComedyBaseCtrl"
    ).when("/#_=_",
        templateUrl: "<%= asset_path 'angular/partials/home.tpl.html' %>"
        controller: "ComedyBaseCtrl"
    ).when("/about",
        templateUrl: "<%= asset_path 'angular/partials/about.tpl.html' %>"
    ).when("/type",
        templateUrl: "<%= asset_path 'angular/partials/events/choose_event.tpl.html' %>"
        controller: "TypeaheadCtrl"
    ).when("/profile/me",
        templateUrl: "<%= asset_path 'angular/partials/settings/edit_profile.tpl.html' %>"
        controller: "ComedyBaseProfileCtrl"
    ).when("/profile/events",
      templateUrl: "<%= asset_path 'angular/partials/settings/manage_events.tpl.html' %>"
    ).when("/venues",
        templateUrl: "<%= asset_path 'angular/partials/venues/list.tpl.html' %>"
        controller: "VenuesCtrl"
    ).when("/events",
      templateUrl: "<%= asset_path 'angular/partials/events/list.tpl.html' %>"
      controller: "EventsCtrl"
    ).when("/me/events",
        templateUrl: "<%= asset_path 'angular/partials/events/edit_events.tpl.html' %>"
        controller: "ComedyBaseProfileCtrl"
    ).when("/events/add",
        templateUrl: "<%= asset_path 'angular/partials/events/choose_event.tpl.html' %>"
        controller: "ComedyBaseProfileCtrl"
    ).when("/:slug",
        templateUrl: "<%= asset_path 'angular/partials/profile.tpl.html' %>"
        controller: "ComedyBaseUserCtrl"
    ).otherwise redirectTo: "/"
  ]

#****************************************
#* /Router
#****************************************

